import{_ as s,c as i,o as a,a2 as e}from"./chunks/framework.D8Prfz4N.js";const t="/books/assets/2fa7318e270d451684c3f8da78bbab5c~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.CtsVM9ME.awebp",n="/books/assets/3885498f30a7462789d05fe8af482c6f~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.CO425FKd.awebp",l="/books/assets/1ebe7f1a58974319badd51afa21d9f62~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.CegL3yFL.awebp",o="/books/assets/5a3c5cc523044b959ec2ae1fcefee6a4~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.DJcFDLIM.awebp",p="/books/assets/830f8d072cfd4b8bae4c95e7d29c974b~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.BiTt9oDv.awebp",d="/books/assets/0630aad5c07744f8be3d2a3d0198d959~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.CtC0QanL.awebp",h="/books/assets/98e6b0cd9aa54f6b8f3090dcd36c91b9~tplv-k3u1fbpfcp-zoom-in-crop-mark_3024_0_0_0.CJ2b8N0s.awebp",C=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"pamphlet/webpack5/29 Sourcemap：源码映射原理与应用技巧.md","filePath":"pamphlet/webpack5/29 Sourcemap：源码映射原理与应用技巧.md"}'),c={name:"pamphlet/webpack5/29 Sourcemap：源码映射原理与应用技巧.md"},k=e('<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k%2Fedit%23heading%3Dh.qz3o9nc69um5" target="_blank" rel="noreferrer">Sourcemap 协议</a> 最初由 Google 设计并率先在 Closure Inspector 实现，它的主要作用就是将经过压缩、混淆、合并的产物代码还原回未打包的原始形态，帮助开发者在生产环境中精确定位问题发生的行列位置，例如：</p><p><img src="'+t+`" alt="image.png"></p><p>在 Webpack 内部，这段生成 Sourcemap 映射数据的逻辑并不复杂，一句话总结：在 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fcompilation-hooks%2F%23processassets" target="_blank" rel="noreferrer">processAssets</a> 钩子遍历产物文件 <code>assets</code> 数组，调用 <code>webpack-sources</code> 提供的 <code>map</code> 方法，最终计算出 <code>asset</code> 与源码 <code>originSource</code> 之间的映射关系。</p><p>这个过程真正的难点在于 「如何计算映射关系」，因此本文会展开详细讲解 Sourcemap 映射结构与 VLQ 编码规则，以及 Webpack 提供的 <code>devtool</code> 配置项的详细用法。</p><h2 id="sourcemap-映射结构" tabindex="-1">Sourcemap 映射结构 <a class="header-anchor" href="#sourcemap-映射结构" aria-label="Permalink to &quot;Sourcemap 映射结构&quot;">​</a></h2><p>Sourcemap 最初版本生成的 <code>.map</code> 文件非常大，体积大概为编译产物的 10 倍；V2 之后引入 Base64 编码等算法，将之减少 20% ~ 30%；而最新版本 V3 又在 V2 基础上引入 VLQ 算法，体积进一步压缩了 50%。</p><p>这一系列进化造就了一个效率极高的 Sourcemap 体系，但伴随而来的则是较为复杂的 <code>mappings</code> 编码规则。V3 版本 Sourcemap 文件由三部分组成:</p><ul><li>开发者编写的原始代码；</li><li>经过 Webpack 压缩、转化、合并后的产物，且产物中必须包含指向 Sourcemap 文件地址的 <code>//# sourceMappingURL=https://xxxx/bundle.js.map</code> 指令；</li><li>记录原始代码与经过工程化处理代码之间位置映射关系 Map 文件。</li></ul><p>页面初始运行时只会加载编译构建产物，直到特定事件发生 —— 例如在 Chrome 打开 Devtool 面板时，才会根据 <code>//# sourceMappingURL</code> 内容自动加载 Map 文件，并按 Sourcemap 协议约定的映射规则将代码重构还原回原始形态，这既能保证终端用户的性能体验，又能帮助开发者快速还原现场，提升线上问题的定位与调试效率。</p><p>例如，在 Webpack 中设置 <code>devtool = &#39;source-map&#39;</code> 即可同时打包出代码产物 <code>xxx.js</code> 文件与同名 <code>xxx.js.map</code> 文件，Map 文件通常为 JSON 格式，内容如：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;webpack:///./src/index.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;names&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;console&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;log&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;mappings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;;;;;;AAAA,IAAMA,IAAI,GAAG,QAAb;AAEAC,OAAO,CAACC,GAAR,CAAYF,IAAZ,E&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sourcesContent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;const name = &#39;tecvan&#39;;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">console.log(name)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sourceRoot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>各字段含义分别为：</p><ul><li><code>version</code>： 指代 Sourcemap 版本，目前最新版本为 <code>3</code>；</li><li><code>names</code>：字符串数组，记录原始代码中出现的变量名；</li><li><code>file</code>：字符串，该 Sourcemap 文件对应的编译产物文件名；</li><li><code>sourcesContent</code>：字符串数组，原始代码的内容；</li><li><code>sourceRoot</code>：字符串，源文件根目录；</li><li><code>sources</code>：字符串数组，原始文件路径名，与 <code>sourcesContent</code> 内容一一对应；</li><li><code>mappings</code>：字符串数组，记录打包产物与原始代码的位置映射关系。</li></ul><p>使用时，浏览器会按照 <code>mappings</code> 记录的数值关系，将产物代码映射回 <code>sourcesContent</code> 数组所记录的原始代码文件、行、列位置，这里面最复杂难懂的点就在于 <code>mappings</code> 字段的规则。</p><p>举个例子，对于下面的代码：</p><table tabindex="0"><thead><tr><th>编译前</th><th>编译后</th></tr></thead><tbody><tr><td><code>const name = &#39;tecvan&#39;; console.log(name) </code></td><td><code>/******/ (() =&gt; { // webpackBootstrap var __webpack_exports__ = {}; /*!**********************!*\\ !*** ./src/index.js ***! \\**********************/ var name = &#39;tecvan&#39;; console.log(name); /******/ })() ; //# sourceMappingURL=main.js.map </code></td></tr></tbody></table><p>当 <code>devtool = &#39;source-map&#39;</code> 时，Webpack 生成的 <code>mappings</code> 字段为：</p><div class="language-objectivec vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">objectivec</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>;;;;;AAAA,IAAMA,IAAI,GAAG,QAAb;AAEAC,OAAO,CAACC,GAAR,CAAYF,IAAZ,E</span></span></code></pre></div><p>字段内容包含三层结构：</p><ul><li>以 <code>;</code> 分割的<strong>行映射</strong>，每一个 <code>;</code> 对应编译产物每一行到源码的映射，上例经过分割后：</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 1-5 行内容为 Webpack 生成的 runtime，不需要记录映射关系</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 6 行的映射信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;AAAA,IAAMA,IAAI,GAAG,QAAb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 7 行的映射信息</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;AAEAC,OAAO,CAACC,GAAR,CAAYF,IAAZ,E&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><ul><li>以 <code>,</code> 分割的<strong>片段映射</strong>，每一个 <code>,</code> 对应该行中每一个代码片段到源码的映射，上例经过分割后：</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 1-5 行内容为 Webpack 生成的 runtime，不需要记录映射关系</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 6 行的映射信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 片段 \`var\` 到 \`const\` 的映射</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;AAAA&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 片段 \`name\` 到 \`name\` 的映射</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;IAAMA&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 等等</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;IAAI&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GAAG&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;QAAb&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 7 行的映射信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;AAEAC&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;OAAO&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CAACC&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;GAAR&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;CAAYF&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;IAAZ&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;E&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><ul><li><p>第三层逻辑为片段映射到源码的具体位置，以上例</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>IAAMA</span></span></code></pre></div><p>为例：</p><ul><li>第一位 <code>I</code> 代表该代码片段在产物中列数；</li><li>第二位 <code>A</code> 代表源码文件的索引，即该片段对标到 <code>sources</code> 数组的元素下标；</li><li>第三位 <code>A</code> 代表片段在源码文件的行数；</li><li>第四位 <code>M</code> 代表片段在源码文件的列数；</li><li>第五位 <code>A</code> 代表该片段对应的名称索引，即该片段对标到 <code>names</code> 数组的元素下标。</li></ul></li></ul><p>上述第1、2层逻辑比较简单，唯一需要注意的是片段之间是一种相对偏移关系，例如对于上例第六行映射值：<code>AAAA,IAAMA,IAAI,GAAG,QAAb</code>，每一个片段的第一位 —— 即片段列数为 <code>A,I,I,G,Q</code>，分别代表：</p><ul><li><code>A</code> ：第 <code>A</code> 列；</li><li><code>I</code> ：第 <code>A + I</code> 列；</li><li><code>I</code> ：第 <code>A + I + I</code> 列；</li><li><code>G</code> ：第 <code>A + I + I + G</code> 列；</li><li><code>Q</code> ：第 <code>A + I + I + G + Q</code> 列。</li></ul><p>这种相对偏移能减少 Sourcemap 产物的体积，提升整体性能。注意，第三层逻辑中的片段位置映射则用到了一种比较高效数值编码算法 —— VLQ(Variable-length Quantity)。</p><h2 id="vlq-编码" tabindex="-1">VLQ 编码 <a class="header-anchor" href="#vlq-编码" aria-label="Permalink to &quot;VLQ 编码&quot;">​</a></h2><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FVariable-lengsth_quantity" target="_blank" rel="noreferrer">VLQ</a> 是一种将整数数值转换为 Base64 的编码算法，它先将任意大的整数转换为一系列六位字节码，再按 Base64 规则转换为一串可见字符。VLQ 使用六位比特存储一个编码分组，例如：</p><p><img src="`+n+'" alt="image.png"></p><p>数字 7 经过 VLQ 编码后，结果为 <code>001110</code>，其中：</p><ul><li>第一位为连续标志位，标识后续分组是否为同一数字；</li><li>第六位表示该数字的正负符号，0为正整数，1为负整数；</li><li>中间第 2-5 为实际数值。</li></ul><p>这样一个六位编码分组，就可以按照 Base64 的映射规则转换为 <code>ABC</code> 等可见字符，例如上述数字 7 编码结果 <code>001110</code>，等于十进制的 14，按 Base64 字码表可映射为字母 <code>O</code>。</p><p><img src="'+l+`" alt="image.png"></p><p>但是，分组中只有中间的 4 个字节用于表示数值，因此单个分组只能表达 <strong>-15 ~ 15</strong> 之间的数值范围，对于超过这个范围的整数，需要组合多个分组，共同表达同一数字，具体规则：</p><ul><li>第一个分组的最后一位为符号位，其它分组从 2-6 均为数值位；</li><li>取二进制值最后四位为第一个分组值，之后从后到前，每 5 位划分为一个分组；</li><li>除最后一个分组外，其余分组的连续标志位都设置为 1。</li></ul><p>例如，对于十进制 -17，其二进制为 <code>10001</code> (取 17 的二进制) 共 5 位，首先从后到前拆分为两组，后四位 <code>0001</code> 为第一组，连续标志位为 1，符号位为 1，结果为 <code>1,0001,1</code>；剩下的 <code>1</code> 分配到第二个 —— 也是最后一个分组，连续标志位为 0，结果为 <code>0,00001</code>。按 Base64 规则 <code>[100011, 000001]</code> 最终映射为 <code>jA</code>。</p><div class="language-dart vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dart</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">十进制     二进制               </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VLQ</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Base64</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">17</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0001</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100011</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">000001</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     jA</span></span></code></pre></div><p>同样的，对于更大的数字，例如 1200，其二进制为 <code>10010110000</code>，分组为 <code>[10, 01011, 0000]</code>，从后到前编码，第一个分组为 <code>1,0000,0</code>；第二个分组为 <code>1,01011</code>；最后一个分组为 <code>0,00010</code>。按 Base64 映射为 <code>grC</code>。</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">十进制            二进制                     VLQ    Base64</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 1200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =&gt; 10</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;01011;0000 =&gt; 100000,101011,000010 =&gt;    grC</span></span></code></pre></div><p><img src="`+o+`" alt="image.png"></p><p>结合 VLQ 编码规则，我们再回过头来解读本章开头的例子，对于代码：</p><table tabindex="0"><thead><tr><th>编译前</th><th>编译后</th></tr></thead><tbody><tr><td><code>const name = &#39;tecvan&#39;; console.log(name) </code></td><td><code>/******/ (() =&gt; { // webpackBootstrap var __webpack_exports__ = {}; /*!**********************!*\\ !*** ./src/index.js ***! \\**********************/ var name = &#39;tecvan&#39;; console.log(name); /******/ })() ; //# sourceMappingURL=main.js.map </code></td></tr></tbody></table><p>编译生成 <code>mappings</code>：</p><div class="language-objectivec vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">objectivec</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>;;;;;AAAA,IAAMA,IAAI,GAAG,QAAb;AAEAC,OAAO,CAACC,GAAR,CAAYF,IAAZ,E</span></span></code></pre></div><p>按行、片段规则分割后，得出如下片段：</p><div class="language-csharp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 1-5 行内容为 Webpack 生成的 runtime，不需要记录映射关系</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 6 行的映射信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AAAA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IAAMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IAAI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GAAG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">QAAb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;], </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 产物第 7 行的映射信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AAEAC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">OAAO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CAACC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GAAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CAAYF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IAAZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;, &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>以第 6 行 <code>[&#39;AAAA&#39;, &#39;IAAMA&#39;, &#39;IAAI&#39;, &#39;GAAG&#39;, &#39;QAAb&#39;]</code> 为例：</p><ul><li><code>AAAA</code> 解码结果为 <code>[000000, 000000, 000000, 000000]</code>，即产物第 6 行<strong>第</strong> <strong>0</strong> <strong>列</strong>映射到 <code>sources[0]</code> 文件的<strong>第</strong> <strong>0</strong> <strong>行</strong>，<strong>第</strong> <strong>0</strong> <strong>列</strong>，实际对应 <code>var</code> 到 <code>const</code> 的位置映射；</li><li><code>IAAMA</code> 解码结果为 <code>[001000, 000000, 000000, 001100, 000000]</code>，即产物第 6 行第 4 列映射到 <code>sources[0]</code> 文件的<strong>第</strong> <strong>0</strong> <strong>行</strong>，<strong>第</strong> <strong>6</strong> <strong>列</strong>，实际对应产物 <code>name</code> 到源码 <code>name</code> 的位置映射。</li></ul><p>其它片段以此类推，Webpack 生成 <code>.map</code> 文件时，只需要在 <code>webpack-sources</code> 中，按照这个编码规则计算好编译前后的代码映射关系即可。</p><h2 id="devtool-规则详解" tabindex="-1"><code>devtool</code> 规则详解 <a class="header-anchor" href="#devtool-规则详解" aria-label="Permalink to &quot;\`devtool\` 规则详解&quot;">​</a></h2><p>Webpack 提供了两种设置 Sourcemap 的方式，一是通过 <code>devtool</code> 配置项设置 Sourcemap 规则短语；二是直接使用 <code>SourceMapDevToolPlugin</code> 或 <code>EvalSourceMapDevToolPlugin</code> 插件深度定制 Sourcemap 的生成逻辑。</p><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fdevtool%2F" target="_blank" rel="noreferrer">devtool</a> 支持 25 种字符串枚举值，包括 <code>eval</code>、<code>source-map</code>、<code>eval-source-map</code> 等：</p><table tabindex="0"><thead><tr><th>devtool</th><th>performance</th><th>production</th><th>quality</th><th>comment</th></tr></thead><tbody><tr><td>(none)</td><td>build: fastest rebuild: fastest</td><td>yes</td><td>bundle</td><td>Recommended choice for production builds with maximum performance.</td></tr><tr><td>eval</td><td>build: fast rebuild: fastest</td><td>no</td><td>generated</td><td>Recommended choice for development builds with maximum performance.</td></tr><tr><td>eval-cheap-source-map</td><td>build: ok rebuild: fast</td><td>no</td><td>transformed</td><td>Tradeoff choice for development builds.</td></tr><tr><td>eval-cheap-module-source-map</td><td>build: slow rebuild: fast</td><td>no</td><td>original lines</td><td>Tradeoff choice for development builds.</td></tr><tr><td>eval-source-map</td><td>build: slowest rebuild: ok</td><td>no</td><td>original</td><td>Recommended choice for development builds with high quality SourceMaps.</td></tr><tr><td>cheap-source-map</td><td>build: ok rebuild: slow</td><td>no</td><td>transformed</td><td></td></tr><tr><td>cheap-module-source-map</td><td>build: slow rebuild: slow</td><td>no</td><td>original lines</td><td></td></tr><tr><td>source-map</td><td>build: slowest rebuild: slowest</td><td>yes</td><td>original</td><td>Recommended choice for production builds with high quality SourceMaps.</td></tr><tr><td>inline-cheap-source-map</td><td>build: ok rebuild: slow</td><td>no</td><td>transformed</td><td></td></tr><tr><td>inline-cheap-module-source-map</td><td>build: slow rebuild: slow</td><td>no</td><td>original lines</td><td></td></tr><tr><td>inline-source-map</td><td>build: slowest rebuild: slowest</td><td>no</td><td>original</td><td>Possible choice when publishing a single file</td></tr><tr><td>eval-nosources-cheap-source-map</td><td>build: ok rebuild: fast</td><td>no</td><td>transformed</td><td>source code not included</td></tr><tr><td>eval-nosources-cheap-module-source-map</td><td>build: slow rebuild: fast</td><td>no</td><td>original lines</td><td>source code not included</td></tr><tr><td>eval-nosources-source-map</td><td>build: slowest rebuild: ok</td><td>no</td><td>original</td><td>source code not included</td></tr><tr><td>inline-nosources-cheap-source-map</td><td>build: ok rebuild: slow</td><td>no</td><td>transformed</td><td>source code not included</td></tr><tr><td>inline-nosources-cheap-module-source-map</td><td>build: slow rebuild: slow</td><td>no</td><td>original lines</td><td>source code not included</td></tr><tr><td>inline-nosources-source-map</td><td>build: slowest rebuild: slowest</td><td>no</td><td>original</td><td>source code not included</td></tr><tr><td>nosources-cheap-source-map</td><td>build: ok rebuild: slow</td><td>no</td><td>transformed</td><td>source code not included</td></tr><tr><td>nosources-cheap-module-source-map</td><td>build: slow rebuild: slow</td><td>no</td><td>original lines</td><td>source code not included</td></tr><tr><td>nosources-source-map</td><td>build: slowest rebuild: slowest</td><td>yes</td><td>original</td><td>source code not included</td></tr><tr><td>hidden-nosources-cheap-source-map</td><td>build: ok rebuild: slow</td><td>no</td><td>transformed</td><td>no reference, source code not included</td></tr><tr><td>hidden-nosources-cheap-module-source-map</td><td>build: slow rebuild: slow</td><td>no</td><td>original lines</td><td>no reference, source code not included</td></tr><tr><td>hidden-nosources-source-map</td><td>build: slowest rebuild: slowest</td><td>yes</td><td>original</td><td>no reference, source code not included</td></tr><tr><td>hidden-cheap-source-map</td><td>build: ok rebuild: slow</td><td>no</td><td>transformed</td><td>no reference</td></tr><tr><td>hidden-cheap-module-source-map</td><td>build: slow rebuild: slow</td><td>no</td><td>original lines</td><td>no reference</td></tr><tr><td>hidden-source-map</td><td>build: slowest rebuild: slowest</td><td>yes</td><td>original</td><td>no reference. Possible choice when using SourceMap only for error reporting purposes.</td></tr></tbody></table><blockquote><p>提示：内容摘抄自 Webpack <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fdevtool%2F" target="_blank" rel="noreferrer">官网</a>。</p></blockquote><p>分开来看都特别晦涩，但这些枚举值内在有一个潜规则：都是由 <code>inline</code>、<code>eval</code>、<code>source-map</code>、<code>nosources</code>、<code>hidden</code>、<code>cheap</code>、<code>module</code> 七种关键字组合而成，这些关键词各自代表一项 Sourcemap 规则，拆开来看：</p><ol><li><strong><code>eval</code> 关键字</strong>：当 <code>devtool</code> 值包含 <code>eval</code> 时，生成的模块代码会被包裹进一段 <code>eval</code> 函数中，且模块的 Sourcemap 信息通过 <code>//# sourceURL</code> 直接挂载在模块代码内。例如：</li></ol><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">eval(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;var foo = &#39;bar&#39;\\n\\n\\n//# sourceURL=webpack:///./src/index.ts?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><code>eval</code> 模式编译速度通常比较快，但产物中直接包含了 Sourcemap 信息，因此只推荐在开发环境中使用。</p><ol><li><strong><code>source-map</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>source-map</code> 时，Webpack 才会生成 Sourcemap 内容。例如，对于 <code>devtool = &#39;source-map&#39;</code>，产物会额外生成 <code>.map</code> 文件，形如：</li></ol><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;webpack:///./src/index.ts&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;names&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;console&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;log&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;mappings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;AACAA,QAAQC,IADI&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bundle.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sourcesContent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;const foo = &#39;bar&#39;;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">console.log(foo);&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sourceRoot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>实际上，除 <code>eval</code> 之外的其它枚举值都包含该字段。</p><ol><li><strong><code>cheap</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>cheap</code> 时，生成的 Sourcemap 内容会抛弃<strong>列</strong>维度的信息，这就意味着浏览器只能映射到代码行维度。例如 <code>devtool = &#39;cheap-source-map&#39;</code> 时，产物：</li></ol><div class="language-swift vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">swift</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;version&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;file&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bundle.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;sources&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;webpack:///bundle.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;sourcesContent&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;console.log(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">);&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 带 cheap 效果：</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;mappings&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;AAAA&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 不带 cheap 效果：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // &quot;mappings&quot;: &quot;AACAA,QAAQC,IADI&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;sourceRoot&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>浏览器映射效果：</p><p><img src="`+p+'" alt="image.png"></p><p>虽然 Sourcemap 提供的映射功能可精确定位到文件、行、列粒度，但有时在<strong>行</strong>级别已经足够帮助我们达到调试定位的目的，此时可选择使用 <code>cheap</code> 关键字，简化 Sourcemap 内容，减少 Sourcemap 文件体积。</p><ol><li><strong><code>module</code> 关键字</strong>：<code>module</code> 关键字只在 <code>cheap</code> 场景下生效，例如 <code>cheap-module-source-map</code>、<code>eval-cheap-module-source-map</code>。当 <code>devtool</code> 包含 <code>cheap</code> 时，Webpack 根据 <code>module</code> 关键字判断按 loader 联调处理结果作为 source，还是按处理之前的代码作为 source。例如：</li></ol><p><img src="'+d+`" alt="image.png"></p><p>注意观察上例 <code>sourcesContent</code> 字段，左边 <code>devtool</code> 带 <code>module</code> 关键字，因此此处映射的，是包含 <code>class Person</code> 的最原始代码；而右边生成的 <code>sourcesContent</code> ，则是经过 babel-loader 编译处理的内容。</p><ol><li><strong><code>nosources</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>nosources</code> 时，生成的 Sourcemap 内容中不包含源码内容 —— 即 <code>sourcesContent</code> 字段。例如 <code>devtool = &#39;nosources-source-map&#39;</code> 时，产物：</li></ol><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;webpack:///./src/index.ts&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;names&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;console&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;log&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;mappings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;AACAA,QAAQC,IADI&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bundle.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;sourceRoot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>虽然没有带上源码，但 <code>.map</code> 产物中还带有文件名、 <code>mappings</code> 字段、变量名等信息，依然能够帮助开发者定位到代码对应的原始位置，配合 <code>sentry</code> 等工具提供的源码映射功能，可在异地还原诸如错误堆栈之类的信息。</p><ol><li><strong><code>inline</code> 关键字</strong>：当 <code>devtool</code> 包含 <code>inline</code> 时，Webpack 会将 Sourcemap 内容编码为 Base64 DataURL，直接追加到产物文件中。例如对于 <code>devtool = &#39;inline-source-map&#39;</code>，产物：</li></ol><div class="language-arduino vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">arduino</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>console.log(&quot;bar&quot;);</span></span>
<span class="line"><span>//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOlsiY29uc29sZSIsImxvZyJdLCJtYXBwaW5ncyI6IkFBQ0FBLFFBQVFDLElBREkiLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZm9vID0gJ2Jhcic7XG5jb25zb2xlLmxvZyhmb28pOyJdLCJzb3VyY2VSb290IjoiIn0=</span></span></code></pre></div><p><code>inline</code> 模式编译速度较慢，且产物体积非常大，只适合开发环境使用。</p><ol><li><strong><code>hidden</code> 关键字</strong>：通常，产物中必须携带 <code>//# sourceMappingURL=</code> 指令，浏览器才能正确找到 Sourcemap 文件，当 <code>devtool</code> 包含 <code>hidden</code> 时，编译产物中不包含 <code>//# sourceMappingURL=</code> 指令。例如：</li></ol><table tabindex="0"><thead><tr><th><code>devtool = &#39;hidden-source-map&#39;</code></th><th><code>devtool = &#39;source-map&#39;</code></th></tr></thead><tbody><tr><td><code>/******/ (() =&gt; { // webpackBootstrap var __webpack_exports__ = {}; /*!**********************!*\\ !*** ./src/index.ts ***! \\**********************/ var Person = /** @class */ (function () { }()); /******/ })(); </code></td><td><code>/******/ (() =&gt; { // webpackBootstrap var __webpack_exports__ = {}; /*!**********************!*\\ !*** ./src/index.ts ***! \\**********************/ var Person = /** @class */ (function () { }()); /******/ })(); //# sourceMappingURL=bundle.js.map </code></td></tr></tbody></table><p>两者区别仅在于编译产物最后一行的 <code>//# sourceMappingURL=</code> 指令，当你需要 Sourcemap 功能，又不希望浏览器 Devtool 工具自动加载时，可使用此选项。需要打开 Sourcemap 时，可在浏览器中手动加载：</p><p><img src="`+h+`" alt="f412b094-f908-42a3-9b51-a3f3622a71c0.gif"></p><p>总结一下，Webpack 的 <code>devtool</code> 值都是由以上七种关键字的一个或多个组成，虽然提供了 27 种候选项，但逻辑上都是由上述规则叠加而成，例如：</p><ul><li><code>cheap-source-map</code>：代表 <strong>不带列映射</strong> 的 Sourcemap ；</li><li><code>eval-nosources-cheap-source-map</code>：代表 <strong>以 <code>eval</code> 包裹模块代码</strong> ，且 <strong><code>.map</code> 映射文件中不带源码</strong>，且 <strong>不带列映射</strong> 的 Sourcemap。</li></ul><p>其它选项以此类推。最后再总结一下：</p><ul><li>对于开发环境，适合使用： <ul><li><code>eval</code>：速度极快，但只能看到原始文件结构，看不到打包前的代码内容；</li><li><code>cheap-eval-source-map</code>：速度比较快，可以看到打包前的代码内容，但看不到 loader 处理之前的源码；</li><li><code>cheap-module-eval-source-map</code>：速度比较快，可以看到 loader 处理之前的源码，不过定位不到列级别；</li><li><code>eval-source-map</code>：初次编译较慢，但定位精度最高；</li></ul></li><li>对于生产环境，则适合使用： <ul><li><code>source-map</code>：信息最完整，但安全性最低，外部用户可轻易获取到压缩、混淆之前的源码，慎重使用；</li><li><code>hidden-source-map</code>：信息较完整，安全性较低，外部用户获取到 <code>.map</code> 文件地址时依然可以拿到源码；</li><li><code>nosources-source-map</code>：源码信息缺失，但安全性较高，需要配合 Sentry 等工具实现完整的 Sourcemap 映射。</li></ul></li></ul><h2 id="使用-source-map-插件" tabindex="-1">使用 <code>source-map</code> 插件 <a class="header-anchor" href="#使用-source-map-插件" aria-label="Permalink to &quot;使用 \`source-map\` 插件&quot;">​</a></h2><p>上面介绍的 <code>devtool</code> 配置项，本质上只是一种方便记忆、使用的规则缩写短语，Sourcemap 的底层处理逻辑实际由 <code>SourceMapDevToolPlugin</code> 与 <code>EvalSourceMapDevToolPlugin</code> 插件实现。</p><p>在 <code>devtool</code> 基础上，插件还提供了更多、更细粒度的配置项，用于满足更复杂的需求场景，包括：</p><ul><li>使用 <code>test</code>、<code>include</code>、<code>exclude</code> 配置项过滤需要生成 Sourcemap 的 Bundle；</li><li>使用 <code>append</code>、<code>filename</code>、<code>moduleFilenameTemplate</code>、<code>publicPath</code> 配置项设定 Sourcemap 文件的文件名、URL 。</li></ul><p>使用方法与其它插件无异，如：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> webpack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;webpack&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exports</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  devtool: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> webpack.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SourceMapDevToolPlugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      exclude: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vendor.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>插件配置规则较简单，此处不赘述。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>综上，Sourcemap 是一种高效的位置映射算法，它将产物到源码之间的位置关系表达为 <code>mappings</code> 分层设计与 VLQ 编码，再通过 Chrome、Safari、VS Code、Sentry 等工具异地还原为接近开发状态的源码形式。</p><p>在 Webpack 中，通常只需要选择适当的 <code>devtool</code> 短语即可满足大多数场景需求，特殊情况下也可以直接使用 <code>SourceMapDevToolPlugin</code> 做更深度的定制化。</p><h2 id="思考题" tabindex="-1">思考题 <a class="header-anchor" href="#思考题" aria-label="Permalink to &quot;思考题&quot;">​</a></h2><p>为什么 Sourcemap 要设计分层结构 + VLQ 编码做行列映射？假设直接记录行列号，会有什么问题？</p>`,96),r=[k];function E(u,g,F,y,m,b){return a(),i("div",null,r)}const v=s(c,[["render",E]]);export{C as __pageData,v as default};
